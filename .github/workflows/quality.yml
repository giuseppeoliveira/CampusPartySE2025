name: ðŸ“Š Code Quality & Performance

on:
  push:
    branches: [ prod, dev, melhorias ]
  pull_request:
    branches: [ prod, dev ]
  schedule:
    # Executa todos os dias Ã s 2h da manhÃ£ (UTC)
    - cron: '0 2 * * *'

jobs:
  # ===== ANÃLISE DE CÃ“DIGO =====
  code-quality:
    name: ðŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Para anÃ¡lise completa
          
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ” ESLint Analysis
        run: |
          npx eslint . --ext .ts,.tsx --format json --output-file eslint-report.json || true
          npx eslint . --ext .ts,.tsx || true
        
      - name: ðŸ“Š Generate code metrics
        run: |
          echo "ðŸ“Š Collecting code metrics..."
          echo "ðŸ“ Total files: $(find . -name '*.tsx' -o -name '*.ts' | grep -v node_modules | wc -l)"
          echo "ðŸ“ Lines of code: $(find . -name '*.tsx' -o -name '*.ts' | grep -v node_modules | xargs wc -l | tail -1)"
          echo "ðŸ§© Components: $(find ./components -name '*.tsx' | wc -l)"
          
  # ===== TESTES DE COBERTURA =====
  coverage:
    name: ðŸ§ª Test Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ§ª Run tests with coverage
        run: npm run test:coverage || echo "Tests will be available after installing test dependencies"
        
      - name: ðŸ“Š Coverage Report
        run: |
          echo "ðŸ“Š Test Coverage Report:"
          echo "ðŸ§ª Unit Tests: Ready to implement"
          echo "ðŸ”— Integration Tests: Ready to implement" 
          echo "ðŸ’» Component Tests: Ready to implement"
          
  # ===== ANÃLISE DE PERFORMANCE =====
  performance:
    name: âš¡ Performance Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ—ï¸ Build for analysis
        run: npm run build
        
      - name: ðŸ“Š Bundle Analysis
        run: |
          echo "ðŸ“¦ Bundle Size Analysis:"
          if [ -d "dist" ]; then
            echo "ðŸ“ Dist folder size: $(du -sh dist | cut -f1)"
            echo "ðŸ“„ JavaScript files: $(find dist -name '*.js' -exec du -sh {} \; | sort -rh)"
            echo "ðŸŽ¨ CSS files: $(find dist -name '*.css' -exec du -sh {} \; | sort -rh)"
          else
            echo "âš ï¸ Dist folder not found - build may have failed"
          fi
          
  # ===== DEPENDÃŠNCIAS =====
  dependencies:
    name: ðŸ“¦ Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ðŸ“¥ Install dependencies
        run: npm ci
        
      - name: ðŸ” Check for outdated packages
        run: npm outdated || true
        
      - name: ðŸ”’ Security audit
        run: npm audit || true
        
      - name: ðŸ“Š Dependency summary
        run: |
          echo "ðŸ“¦ Dependency Summary:"
          echo "ðŸ”§ Production deps: $(npm list --prod --depth=0 2>/dev/null | wc -l)"
          echo "âš™ï¸ Dev dependencies: $(npm list --dev --depth=0 2>/dev/null | wc -l)"
          echo "ðŸ“Š Total packages: $(npm list --depth=0 2>/dev/null | wc -l)"